@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì";
}

<div class="row mb-4 fade-in">
    <div class="col-md-8">
        <h2 class="mb-0">
            <i class="fas fa-chart-line text-primary"></i>
            Dashboard ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏õ‡∏µ 2026
        </h2>
        <p class="text-muted">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
    </div>
    <div class="col-md-4 text-end">
        <a asp-controller="Budget" asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
        </a>
    </div>
</div>

<!-- KPI Cards -->
<div class="row g-4 mb-4">
    <!-- Total Proposed -->
    <div class="col-md-3">
        <div class="card fade-in" style="animation-delay: 0.1s">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-file-invoice-dollar"></i>
                            ‡∏á‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </h6>
                        <h3 class="mb-0 text-primary">
                            ‡∏ø@Model.Statistics.TotalProposed.ToString("N0")
                        </h3>
                        <small class="text-muted">@Model.Statistics.TotalItems ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-coins fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Approved -->
    <div class="col-md-3">
        <div class="card fade-in" style="animation-delay: 0.2s">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-check-circle"></i>
                            ‡∏á‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
                        </h6>
                        <h3 class="mb-0 text-success">
                            ‡∏ø@Model.Statistics.TotalApproved.ToString("N0")
                        </h3>
                        <small class="text-muted">@Model.Statistics.ApprovedItems ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-check-double fa-2x opacity-50"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: @Model.Statistics.ApprovalPercentage%">
                    </div>
                </div>
                <small class="text-muted">@Model.Statistics.ApprovalPercentage% ‡∏Ç‡∏≠‡∏á‡∏á‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠</small>
            </div>
        </div>
    </div>

    <!-- Proposed Items -->
    <div class="col-md-3">
        <div class="card fade-in" style="animation-delay: 0.3s">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-clock"></i>
                            ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        </h6>
                        <h3 class="mb-0 text-warning">
                            @Model.Statistics.ProposedItems
                        </h3>
                        <small class="text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-hourglass-half fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rejected Items -->
    <div class="col-md-3">
        <div class="card fade-in" style="animation-delay: 0.4s">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-times-circle"></i>
                            ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        </h6>
                        <h3 class="mb-0 text-danger">
                            @Model.Statistics.RejectedItems
                        </h3>
                        <small class="text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
                    </div>
                    <div class="text-danger">
                        <i class="fas fa-ban fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Budget List -->
<div class="row g-4 mb-4">
    <!-- Charts -->
    <div class="col-lg-6">
        <div class="card fade-in" style="animation-delay: 0.5s">
            <div class="card-header">
                <i class="fas fa-building me-2"></i>
                ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            </div>
            <div class="card-body">
                <canvas id="departmentChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card fade-in" style="animation-delay: 0.6s">
            <div class="card-header">
                <i class="fas fa-tags me-2"></i>
                ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
            </div>
            <div class="card-body">
                <canvas id="categoryChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Budget Items List -->
<div class="card fade-in" style="animation-delay: 0.7s">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-wallet me-2"></i>
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </h5>
    </div>
    <div class="card-body">
        @if (Model.BudgetItems.Count == 0)
        {
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h5>
                <p class="text-muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</p>
                <a asp-controller="Budget" asp-action="Create" class="btn btn-primary mt-3">
                    <i class="fas fa-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                </a>
            </div>
        }
        else
        {
            <!-- Search and Filter -->
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                </div>
                <div class="col-md-3">
                    <select id="categoryFilter" class="form-select">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                        <option value="IT & Automation">IT & Automation</option>
                        <option value="Machinery & Equipment">Machinery & Equipment</option>
                        <option value="Warehouse & Building">Warehouse & Building</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="statusFilter" class="form-select">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                        <option value="proposed">‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</option>
                        <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                        <option value="rejected">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button onclick="resetFilters()" class="btn btn-secondary w-100">
                        <i class="fas fa-redo me-2"></i>Reset
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle" id="budgetTable">
                    <thead>
                        <tr>
                            <th>‡∏£‡∏´‡∏±‡∏™</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                            <th>‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>
                            <th class="text-end">‡∏á‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠</th>
                            <th class="text-end">‡∏á‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
                            <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.BudgetItems)
                        {
                            <tr data-category="@item.Category" data-status="@item.Status">
                                <td><strong>#@item.Id</strong></td>
                                <td>
                                    <strong>@item.Item</strong>
                                    @if (!string.IsNullOrEmpty(item.Description))
                                    {
                                        <br><small class="text-muted">@item.Description</small>
                                    }
                                </td>
                                <td>
                                    <span class="badge bg-info">@item.Category</span>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.Department))
                                    {
                                        <small>@item.Department</small>
                                    }
                                    else
                                    {
                                        <small class="text-muted">-</small>
                                    }
                                </td>
                                <td class="text-end">
                                    <strong>‡∏ø@item.Amount.ToString("N0")</strong>
                                </td>
                                <td class="text-end">
                                    @if (item.ApprovedAmount > 0)
                                    {
                                        <strong class="text-success">‡∏ø@item.ApprovedAmount.ToString("N0")</strong>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (item.Status == "approved")
                                    {
                                        <span class="badge badge-approved">
                                            <i class="fas fa-check me-1"></i>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                        </span>
                                    }
                                    else if (item.Status == "rejected")
                                    {
                                        <span class="badge badge-rejected">
                                            <i class="fas fa-times me-1"></i>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-proposed">
                                            <i class="fas fa-clock me-1"></i>‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤
                                        </span>
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a asp-controller="Budget" asp-action="Details" asp-route-id="@item.Id" 
                                           class="btn btn-info" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a asp-controller="Budget" asp-action="Edit" asp-route-id="@item.Id" 
                                           class="btn btn-warning" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a asp-controller="Voting" asp-action="Create" asp-route-budgetItemId="@item.Id"
                                           class="btn btn-success" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
                                            <i class="fas fa-vote-yea"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <small class="text-muted">
                    ‡πÅ‡∏™‡∏î‡∏á <strong id="displayCount">@Model.BudgetItems.Count</strong> ‡∏à‡∏≤‡∏Å <strong>@Model.BudgetItems.Count</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </small>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
    // Department Chart
    const departmentCtx = document.getElementById('departmentChart').getContext('2d');
    const departmentData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.DepartmentBudgets.Select(d => new { 
            label = d.Department, 
            value = d.TotalAmount 
        })
    ));

    new Chart(departmentCtx, {
        type: 'bar',
        data: {
            labels: departmentData.map(d => d.label),
            datasets: [{
                label: '‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ö‡∏≤‡∏ó)',
                data: departmentData.map(d => d.value),
                backgroundColor: [
                    'rgba(255, 107, 53, 0.8)',
                    'rgba(78, 205, 196, 0.8)',
                    'rgba(149, 225, 211, 0.8)',
                    'rgba(255, 217, 61, 0.8)',
                    'rgba(243, 129, 129, 0.8)'
                ],
                borderWidth: 0,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‡∏ø' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Category Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.CategoryBudgets.Select(c => new { 
            label = c.Category, 
            value = c.TotalAmount 
        })
    ));

    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: categoryData.map(c => c.label),
            datasets: [{
                data: categoryData.map(c => c.value),
                backgroundColor: [
                    'rgba(255, 107, 53, 0.8)',
                    'rgba(78, 205, 196, 0.8)',
                    'rgba(149, 225, 211, 0.8)',
                    'rgba(255, 217, 61, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ‡∏ø' + context.parsed.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Search and Filter
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const table = document.getElementById('budgetTable');
    const tbody = table?.querySelector('tbody');

    function filterTable() {
        if (!tbody) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const category = categoryFilter.value;
        const status = statusFilter.value;
        const rows = tbody.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const rowCategory = row.dataset.category;
            const rowStatus = row.dataset.status;

            const matchesSearch = text.includes(searchTerm);
            const matchesCategory = !category || rowCategory === category;
            const matchesStatus = !status || rowStatus === status;

            if (matchesSearch && matchesCategory && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('displayCount').textContent = visibleCount;
    }

    searchInput?.addEventListener('input', filterTable);
    categoryFilter?.addEventListener('change', filterTable);
    statusFilter?.addEventListener('change', filterTable);

    function resetFilters() {
        searchInput.value = '';
        categoryFilter.value = '';
        statusFilter.value = '';
        filterTable();
    }
</script>
}
