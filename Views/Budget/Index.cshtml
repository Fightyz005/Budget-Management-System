@model List<BudgetItem>
@{
    ViewData["Title"] = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì";
}

<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="mb-0">
            <i class="fas fa-wallet text-primary"></i>
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </h2>
        <p class="text-muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p>
    </div>
    <div class="col-md-4 text-end">
        <a asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
        </a>
    </div>
</div>

<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <input type="text" id="searchInput" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
            </div>
            <div class="col-md-2">
                <select id="categoryFilter" class="form-select">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                    <option value="IT & Automation">IT & Automation</option>
                    <option value="Machinery & Equipment">Machinery & Equipment</option>
                    <option value="Warehouse & Building">Warehouse & Building</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="departmentFilter" class="form-select">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="divisionFilter" class="form-select" disabled>
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏ù‡πà‡∏≤‡∏¢</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="statusFilter" class="form-select">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                    <option value="proposed">‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</option>
                    <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                    <option value="rejected">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                </select>
            </div>
            <div class="col-md-1">
                <button onclick="resetFilters()" class="btn btn-secondary w-100">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Budget Table -->
<div class="card">
    <div class="card-body">
        @if (Model.Count == 0)
        {
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h5>
                <p class="text-muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</p>
                <a asp-action="Create" class="btn btn-primary mt-3">
                    <i class="fas fa-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                </a>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="budgetTable">
                    <thead>
                        <tr>
                            <th>‡∏£‡∏´‡∏±‡∏™</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                            <th>‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏ù‡πà‡∏≤‡∏¢</th>
                            <th class="text-end">‡∏á‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠</th>
                            <th class="text-end">‡∏á‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
                            <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr data-category="@item.Category" 
                                data-status="@item.Status"
                                data-department="@(item.Department ?? "")"
                                data-division="@(item.Division ?? "")">
                                <td><strong>#@item.Id</strong></td>
                                <td>
                                    <strong>@item.Item</strong>
                                    @if (!string.IsNullOrEmpty(item.Description))
                                    {
                                        <br><small class="text-muted">@item.Description</small>
                                    }
                                </td>
                                <td>
                                    <span class="badge bg-info">@item.Category</span>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.Department))
                                    {
                                        <small>@item.Department</small>
                                    }
                                    else
                                    {
                                        <small class="text-muted">-</small>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.Division))
                                    {
                                        <small>@item.Division</small>
                                    }
                                    else
                                    {
                                        <small class="text-muted">-</small>
                                    }
                                </td>
                                <td class="text-end">
                                    <strong>‡∏ø@item.Amount.ToString("N0")</strong>
                                </td>
                                <td class="text-end">
                                    @if (item.ApprovedAmount > 0)
                                    {
                                        <strong class="text-success">‡∏ø@item.ApprovedAmount.ToString("N0")</strong>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (item.Status == "approved")
                                    {
                                        <span class="badge badge-approved">
                                            <i class="fas fa-check me-1"></i>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                        </span>
                                    }
                                    else if (item.Status == "rejected")
                                    {
                                        <span class="badge badge-rejected">
                                            <i class="fas fa-times me-1"></i>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-proposed">
                                            <i class="fas fa-clock me-1"></i>‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤
                                        </span>
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a asp-action="Details" asp-route-id="@item.Id" 
                                           class="btn btn-info" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a asp-action="Edit" asp-route-id="@item.Id" 
                                           class="btn btn-warning" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a asp-controller="Voting" asp-action="Create" asp-route-budgetItemId="@item.Id"
                                           class="btn btn-success" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
                                            <i class="fas fa-vote-yea"></i>
                                        </a>
                                        <button onclick="confirmDelete(@item.Id, '@item.Item')" 
                                                class="btn btn-danger" title="‡∏•‡∏ö">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <small class="text-muted">
                    ‡πÅ‡∏™‡∏î‡∏á <strong id="displayCount">@Model.Count</strong> ‡∏à‡∏≤‡∏Å <strong>@Model.Count</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </small>
            </div>
        }
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <strong id="deleteItemName"></strong> ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                <p class="text-danger mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let departmentsData = [];

    // Load departments for filter
    async function loadDepartments() {
        try {
            const response = await fetch('/api/Department/departments');
            departmentsData = await response.json();
            
            const select = document.getElementById('departmentFilter');
            departmentsData.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                option.setAttribute('data-id', dept.id);
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading departments:', error);
        }
    }

    // Load divisions for filter
    async function loadDivisionsFilter(departmentName) {
        const divisionSelect = document.getElementById('divisionFilter');
        
        // Clear divisions
        divisionSelect.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏ù‡πà‡∏≤‡∏¢</option>';
        divisionSelect.disabled = true;
        
        if (!departmentName) return;
        
        try {
            const dept = departmentsData.find(d => d.name === departmentName);
            if (!dept) return;
            
            const response = await fetch(`/api/Department/divisions/${dept.id}`);
            const divisions = await response.json();
            
            divisions.forEach(div => {
                const option = document.createElement('option');
                option.value = div.name;
                option.textContent = div.name;
                divisionSelect.appendChild(option);
            });
            
            divisionSelect.disabled = false;
        } catch (error) {
            console.error('Error loading divisions:', error);
        }
    }

    // Filter table
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const departmentFilter = document.getElementById('departmentFilter');
    const divisionFilter = document.getElementById('divisionFilter');
    const statusFilter = document.getElementById('statusFilter');
    const table = document.getElementById('budgetTable');
    const tbody = table?.querySelector('tbody');

    function filterTable() {
        if (!tbody) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const category = categoryFilter.value;
        const department = departmentFilter.value;
        const division = divisionFilter.value;
        const status = statusFilter.value;
        const rows = tbody.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const rowCategory = row.dataset.category;
            const rowDepartment = row.dataset.department;
            const rowDivision = row.dataset.division;
            const rowStatus = row.dataset.status;

            const matchesSearch = text.includes(searchTerm);
            const matchesCategory = !category || rowCategory === category;
            const matchesDepartment = !department || rowDepartment === department;
            const matchesDivision = !division || rowDivision === division;
            const matchesStatus = !status || rowStatus === status;

            if (matchesSearch && matchesCategory && matchesDepartment && matchesDivision && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('displayCount').textContent = visibleCount;
    }

    // Event listeners
    searchInput?.addEventListener('input', filterTable);
    categoryFilter?.addEventListener('change', filterTable);
    statusFilter?.addEventListener('change', filterTable);
    
    departmentFilter?.addEventListener('change', async function() {
        const departmentName = this.value;
        if (departmentName) {
            await loadDivisionsFilter(departmentName);
        } else {
            document.getElementById('divisionFilter').innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏ù‡πà‡∏≤‡∏¢</option>';
            document.getElementById('divisionFilter').disabled = true;
        }
        filterTable();
    });
    
    divisionFilter?.addEventListener('change', filterTable);

    function resetFilters() {
        searchInput.value = '';
        categoryFilter.value = '';
        departmentFilter.value = '';
        divisionFilter.value = '';
        divisionFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏ù‡πà‡∏≤‡∏¢</option>';
        divisionFilter.disabled = true;
        statusFilter.value = '';
        filterTable();
    }

    // Delete Confirmation
    let deleteModal;
    function confirmDelete(id, name) {
        document.getElementById('deleteItemName').textContent = name;
        document.getElementById('deleteForm').action = '/Budget/Delete/' + id;
        
        if (!deleteModal) {
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        }
        deleteModal.show();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadDepartments();
    });
</script>
}
