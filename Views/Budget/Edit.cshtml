@model BudgetManagementSystem.Web.Models.BudgetItem
@{
    ViewData["Title"] = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì";
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì #@Model.Id
                </h4>
            </div>
            <div class="card-body">
                <form action="/Budget/EditPost/@Model.Id" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="Id" value="@Model.Id" />

                    @if (ViewData.ModelState.IsValid == false)
                    {
                        <div class="alert alert-danger">
                            <h5>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</h5>
                            <ul>
                                @foreach (var key in ViewData.ModelState.Keys)
                                {
                                    var state = ViewData.ModelState[key];
                                    if (state != null && state.Errors.Count > 0)
                                    {
                                        foreach (var error in state.Errors)
                                        {
                                            <li><strong>@key:</strong> @error.ErrorMessage</li>
                                        }
                                    }
                                }
                            </ul>
                        </div>
                    }

                    <!-- Department and Division -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-building me-1"></i>‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô  <span class="text-danger">*</span>
                            </label>
                            <select id="departmentSelect" class="form-select">
                                <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>
                            </select>
                            <input type="hidden" name="Department" id="departmentName" value="@Model.Department" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-sitemap me-1"></i>‡∏ù‡πà‡∏≤‡∏¢  <span class="text-danger">*</span>
                            </label>
                            <select id="divisionSelect" class="form-select" disabled>
                                <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>
                            </select>
                            <input type="hidden" name="Division" id="divisionName" value="@Model.Division" />
                        </div>
                    </div>

                    <!-- Category - PRE-SELECTED SERVER-SIDE -->
                    <div class="mb-3">
                        <label for="Category" class="form-label">
                            <i class="fas fa-tag me-1"></i>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-danger">*</span>
                        </label>
                        <select name="Category" id="Category" class="form-select" required>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                            <option value="IT & Automation" selected="@(Model.Category == "IT & Automation" ? "selected" : null)">IT & Automation</option>
                            <option value="Machinery & Equipment" selected="@(Model.Category == "Machinery & Equipment" ? "selected" : null)">Machinery & Equipment</option>
                            <option value="Warehouse & Building" selected="@(Model.Category == "Warehouse & Building" ? "selected" : null)">Warehouse & Building</option>
                            <option value="Other" selected="@(Model.Category == "Other" ? "selected" : null)">Other</option>
                        </select>
                    </div>

                    <!-- Project Type and Urgent -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ProjectType" class="form-label">
                                <i class="fas fa-project-diagram me-1"></i>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£  <span class="text-danger">*</span>
                            </label>

                            <select name="ProjectType" id="ProjectType" class="form-select">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                                <option value="Replacement" selected="@(Model.ProjectType == "Replacement" ? "selected" : null)">Replacement</option>
                                <option value="Upgrade" selected="@(Model.ProjectType == "Upgrade" ? "selected" : null)">Upgrade</option>
                                <option value="Compliance" selected="@(Model.ProjectType == "Compliance" ? "selected" : null)">Compliance</option>
                                <option value="Expansion" selected="@(Model.ProjectType == "Expansion" ? "selected" : null)">Expansion</option>
                                <option value="Replacement/Upgrade" selected="@(Model.ProjectType == "Replacement/Upgrade" ? "selected" : null)">Replacement/Upgrade</option>
                                <option value="Quality Improvement" selected="@(Model.ProjectType == "Quality Improvement" ? "selected" : null)">Quality Improvement</option>
                                <option value="Strategic" selected="@(Model.ProjectType == "Strategic" ? "selected" : null)">Strategic</option>
                                <option value="Productivity" selected="@(Model.ProjectType == "Productivity" ? "selected" : null)">Productivity</option>
                                <option value="Cost Saving" selected="@(Model.ProjectType == "Cost Saving" ? "selected" : null)">Cost Saving</option>
                                <option value="Safety" selected="@(Model.ProjectType == "Safety" ? "selected" : null)">Safety</option>
                            </select>

                            <span asp-validation-for="ProjectType" class="text-danger"></span>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label asp-for="Urgent" class="form-label">
                                <i class="fas fa-exclamation-circle me-1"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô  <span class="text-danger">*</span>
                            </label>

                            <select asp-for="Urgent" class="form-select">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
                                <option value="1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å" selected="@(Model.Urgent == "1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å" ? "selected" : null)">1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
                                <option value="2.‡∏î‡πà‡∏ß‡∏ô" selected="@(Model.Urgent == "2.‡∏î‡πà‡∏ß‡∏ô" ? "selected" : null)">2.‡∏î‡πà‡∏ß‡∏ô</option>
                                <option value="3.‡∏õ‡∏Å‡∏ï‡∏¥" selected="@(Model.Urgent == "3.‡∏õ‡∏Å‡∏ï‡∏¥" ? "selected" : null)">3.‡∏õ‡∏Å‡∏ï‡∏¥</option>
                            </select>
                            <span asp-validation-for="Urgent" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Start Date -->

                    <div class="mb-3">

                        <label asp-for="StartDate" class="form-label">
                            <i class="fas fa-calendar me-1"></i>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                        </label>
                        <input asp-for="StartDate" type="date" class="form-control">

                        <span asp-validation-for="StartDate" class="text-danger"></span>
                    </div>

                    <!-- Item Name -->
                    <div class="mb-3">
                        <label for="Item" class="form-label">
                            <i class="fas fa-file-alt me-1"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="Item" id="Item" class="form-control"
                               value="@Model.Item" required>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="Description" class="form-label">
                            <i class="fas fa-align-left me-1"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </label>
                        <textarea name="Description" id="Description" class="form-control" rows="3">@Model.Description</textarea>
                    </div>

                    

                    <!-- Amount -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="Amount" class="form-label">
                                <i class="fas fa-money-bill-wave me-1"></i>‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠ (‡∏ö‡∏≤‡∏ó) <span class="text-danger">*</span>
                            </label>
                            <input type="number" name="Amount" id="Amount" class="form-control"
                                   value="@Model.Amount" step="1.00" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ApprovedAmount" class="form-label">
                                <i class="fas fa-check-circle me-1"></i>‡∏á‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ö‡∏≤‡∏ó)
                            </label>
                            <input type="number" name="ApprovedAmount" id="ApprovedAmount" class="form-control"
                                   value="@Model.ApprovedAmount" step="0.01" min="0" disabled>
                        </div>
                    </div>

                    <!-- Benefits -->
                    <div class="mb-3">
                        <label for="Benefits" class="form-label">
                            <i class="fas fa-thumbs-up me-1"></i>‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                        </label>
                        <textarea name="Benefits" id="Benefits" class="form-control" rows="2">@Model.Benefits</textarea>
                    </div>

                    <!-- Worthiness -->
                    <div class="mb-3">
                        <label for="Worthiness" class="form-label">
                            <i class="fas fa-star me-1"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤
                        </label>
                        <textarea name="Worthiness" id="Worthiness" class="form-control" rows="2">@Model.Worthiness</textarea>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="Notes" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                        </label>
                        <textarea name="Notes" id="Notes" class="form-control" rows="2">@Model.Notes</textarea>
                    </div>

                    <!-- Status - PRE-SELECTED SERVER-SIDE -->
                    <div class="mb-4">
                        <label for="Status" class="form-label">
                            <i class="fas fa-flag me-1"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        </label>
                        <select name="Status" id="Status" class="form-select" disabled>
                            <option value="proposed" selected="@(Model.Status == "proposed" ? "selected" : null)">‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ (Proposed)</option>
                            <option value="approved" selected="@(Model.Status == "approved" ? "selected" : null)">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (Approved)</option>
                            <option value="rejected" selected="@(Model.Status == "rejected" ? "selected" : null)">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Rejected)</option>
                        </select>
                    </div>


                    <!-- ‚úÖ NEW: File Upload Section -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-paperclip me-1"></i>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
                        </label>

                        @if (Model.HasFile)
                        {
                            <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                            <div class="alert alert-info">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        @{
                                            var fileIcon = Model.FileExtension?.ToLower() switch
                                            {
                                                ".pdf" => "fas fa-file-pdf text-danger",
                                                ".pptx" => "fas fa-file-powerpoint text-warning",
                                                ".xlsx" => "fas fa-file-excel text-success",
                                                ".csv" => "fas fa-file-csv text-info",
                                                _ => "fas fa-file"
                                            };
                                        }
                                        <i class="@fileIcon fa-2x me-3"></i>
                                        <strong>@Model.FileName</strong>
                                        <br>
                                        <small class="text-muted">
                                            ‡∏Ç‡∏ô‡∏≤‡∏î: @Model.FileSizeFormatted |
                                            ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: @Model.FileUploadDate?.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </div>
                                    <div>
                                        <a href="@Url.Action("DownloadFile", "Budget", new { id = Model.Id })"
                                           class="btn btn-sm btn-primary me-2">
                                            <i class="fas fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                                        </a>
                                        <button type="button" class="btn btn-sm btn-danger"
                                                onclick="deleteFile(@Model.Id)">
                                            <i class="fas fa-trash"></i> ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà -->
                        <input asp-for="UploadedFile" type="file" class="form-control"
                               accept=".pdf,.pptx,.xlsx,.csv"
                               onchange="showFileInfo(this)">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            @if (Model.HasFile)
                            {
                                <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°</span>
                            }
                            else
                            {
                                <span>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: PDF, PowerPoint, Excel, CSV (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 MB)</span>
                            }
                        </small>
                        <div id="fileInfo" class="mt-2"></div>
                    </div>


                    <!-- Buttons -->
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="/Budget/Index" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function showFileInfo(input) {
            const fileInfo = document.getElementById('fileInfo');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                const fileExtension = fileName.split('.').pop().toLowerCase();

                const allowedExtensions = ['pdf', 'pptx', 'xlsx', 'csv'];
                if (!allowedExtensions.includes(fileExtension)) {
                    fileInfo.innerHTML = `
                        <div class="alert alert-danger alert-sm">
                            <i class="fas fa-times-circle me-2"></i>
                            ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞: .pdf, .pptx, .xlsx, .csv
                        </div>
                    `;
                    input.value = '';
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    fileInfo.innerHTML = `
                        <div class="alert alert-danger alert-sm">
                            <i class="fas fa-times-circle me-2"></i>
                            ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ! ‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 MB
                        </div>
                    `;
                    input.value = '';
                    return;
                }

                const icon = getFileIcon(fileExtension);
                fileInfo.innerHTML = `
                    <div class="alert alert-success alert-sm">
                        <i class="${icon} me-2"></i>
                        <strong>${fileName}</strong> (${fileSize} KB)
                    </div>
                `;
            } else {
                fileInfo.innerHTML = '';
            }
        }

        function getFileIcon(extension) {
            switch(extension) {
                case 'pdf': return 'fas fa-file-pdf text-danger';
                case 'pptx': return 'fas fa-file-powerpoint text-warning';
                case 'xlsx': return 'fas fa-file-excel text-success';
                case 'csv': return 'fas fa-file-csv text-info';
                default: return 'fas fa-file';
            }
        }

        // ‚úÖ NEW: ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå
        async function deleteFile(id) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                return;
            }

            try {
                const response = await fetch(`/Budget/DeleteFile/${id}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                if (response.ok) {
                    alert('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    location.reload();
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å Model (escape special characters)
        const existingData = {
            id: @Model.Id,
            category: '@Html.Raw(Model.Category?.Replace("'", "\\'") ?? "")',
            department: '@Html.Raw(Model.Department?.Replace("'", "\\'") ?? "")',
            division: '@Html.Raw(Model.Division?.Replace("'", "\\'") ?? "")',
            status: '@Html.Raw(Model.Status?.Replace("'", "\\'") ?? "")'
        };

        console.log('üìä Existing Data:', existingData);

        $(document).ready(async function() {
            console.log('‚úÖ Edit page loaded - ID:', existingData.id);

            // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÇ‡∏´‡∏•‡∏î Departments
            await loadDepartments();

            // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏´‡∏≤ Department ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
            await selectExistingDepartment();

            // Form submit handler
            $('form').on('submit', function(e) {
                console.log('üîµ FORM SUBMIT - EditPost ID:', existingData.id);

                const formData = new FormData(this);
                console.log('=== Form Data ===');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                // Validation
                const category = formData.get('Category');
                const item = formData.get('Item');
                const amount = formData.get('Amount');

                if (!category) {
                    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
                    e.preventDefault();
                    return false;
                }
                if (!item) {
                    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    e.preventDefault();
                    return false;
                }
                if (!amount || parseFloat(amount) <= 0) {
                    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
                    e.preventDefault();
                    return false;
                }

                console.log('‚úÖ Validation passed!');
            });
        });

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        async function loadDepartments() {
            try {
                console.log('üîÑ Loading departments...');
                const response = await fetch('/api/Department/departments');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const departments = await response.json();
                console.log('‚úÖ Departments loaded:', departments.length);

                const select = $('#departmentSelect');
                select.empty();
                select.append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô --</option>');

                departments.forEach(dept => {
                    select.append(`<option value="${dept.id}" data-name="${dept.name}">${dept.name}</option>`);
                });

                // Store departments in global variable
                window.departmentsData = departments;

            } catch (error) {
                console.error('‚ùå Error loading departments:', error);
                $('#departmentSelect').html('<option value="">-- ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ --</option>');
            }
        }

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Department ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
        async function selectExistingDepartment() {
            if (!existingData.department) {
                console.log('‚ÑπÔ∏è No existing department');
                return;
            }

            console.log('üîç Looking for department:', existingData.department);

            // ‡∏´‡∏≤ department ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
            const dept = window.departmentsData?.find(d => d.name === existingData.department);

            if (dept) {
                console.log('üéØ Found department:', dept.name, 'ID:', dept.id);

                // Select department
                $('#departmentSelect').val(dept.id);
                $('#departmentName').val(dept.name);

                // Highlight ‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                $('#currentDept').css('color', 'green').text(dept.name + ' ‚úì');

                // ‡πÇ‡∏´‡∏•‡∏î divisions
                await loadDivisions(dept.id, true);
            } else {
                console.log('‚ö†Ô∏è Department not found:', existingData.department);
                $('#currentDept').css('color', 'orange').text(existingData.department + ' (‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)');
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢
        async function loadDivisions(departmentId, selectExisting = false) {
            try {
                console.log('üîÑ Loading divisions for dept:', departmentId);

                const response = await fetch(`/api/Department/divisions/${departmentId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const divisions = await response.json();
                console.log('‚úÖ Divisions loaded:', divisions.length);

                const select = $('#divisionSelect');
                select.empty();
                select.append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢ --</option>');

                divisions.forEach(div => {
                    select.append(`<option value="${div.id}" data-name="${div.name}">${div.name}</option>`);
                });

                select.prop('disabled', false);

                // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ select ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                if (selectExisting && existingData.division) {
                    const div = divisions.find(d => d.name === existingData.division);
                    if (div) {
                        console.log('üéØ Found division:', div.name, 'ID:', div.id);
                        select.val(div.id);
                        $('#divisionName').val(div.name);
                        $('#currentDiv').css('color', 'green').text(div.name + ' ‚úì');
                    } else {
                        console.log('‚ö†Ô∏è Division not found:', existingData.division);
                        $('#currentDiv').css('color', 'orange').text(existingData.division + ' (‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)');
                    }
                }

            } catch (error) {
                console.error('‚ùå Error loading divisions:', error);
                $('#divisionSelect').html('<option value="">-- ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ --</option>');
            }
        }

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Department
        $('#departmentSelect').change(async function() {
            const selectedOption = $(this).find('option:selected');
            const departmentId = $(this).val();
            const departmentName = selectedOption.data('name');

            console.log('üìç Department changed:', departmentName);
            $('#departmentName').val(departmentName || '');

            if (departmentId) {
                $('#divisionSelect').html('<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>').prop('disabled', true);
                $('#divisionName').val('');
                await loadDivisions(departmentId, false);
            } else {
                $('#divisionSelect').html('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option>').prop('disabled', true);
                $('#divisionName').val('');
            }
        });

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Division
        $('#divisionSelect').change(function() {
            const selectedOption = $(this).find('option:selected');
            const divisionName = selectedOption.data('name');

            console.log('üìç Division changed:', divisionName);
            $('#divisionName').val(divisionName || '');
        });
    </script>
}
