@model BudgetManagementSystem.Web.Models.BudgetItem
@{
    ViewData["Title"] = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì";
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÉ‡∏´‡∏°‡πà
                </h4>
            </div>
            <div class="card-body">
                <!-- ‚ö†Ô∏è IMPORTANT: action="CreatePost" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å CreatePost() method -->
                <form action="/Budget/CreatePost" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    
                    @if (ViewData.ModelState.IsValid == false)
                    {
                        <div class="alert alert-danger">
                            <h5>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</h5>
                            <ul>
                                @foreach (var key in ViewData.ModelState.Keys)
                                {
                                    var state = ViewData.ModelState[key];
                                    if (state != null && state.Errors.Count > 0)
                                    {
                                        foreach (var error in state.Errors)
                                        {
                                            <li><strong>@key:</strong> @error.ErrorMessage</li>
                                        }
                                    }
                                }
                            </ul>
                        </div>
                    }

                    <!-- Department and Division -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-building me-1"></i>‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô  <span class="text-danger">*</span>
                            </label>
                            <select id="departmentSelect" class="form-select">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô --</option>
                            </select>
                            <input type="hidden" name="Department" id="departmentName" value="@Model?.Department" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-sitemap me-1"></i>‡∏ù‡πà‡∏≤‡∏¢  <span class="text-danger">*</span>
                            </label>
                            <select id="divisionSelect" class="form-select" disabled>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option>
                            </select>
                            <input type="hidden" name="Division" id="divisionName" value="@Model?.Division" />
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="mb-3">
                        <label for="Category" class="form-label">
                            <i class="fas fa-tag me-1"></i>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-danger">*</span>
                        </label>
                        <select name="Category" id="Category" class="form-select" required>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                            <option value="IT & Automation">IT & Automation</option>
                            <option value="Machinery & Equipment">Machinery & Equipment</option>
                            <option value="Warehouse & Building">Warehouse & Building</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <!-- Item Name -->
                    <div class="mb-3">
                        <label for="Item" class="form-label">
                            <i class="fas fa-file-alt me-1"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="Item" id="Item" class="form-control" 
                               value="@Model?.Item" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà" required>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="Description" class="form-label">
                            <i class="fas fa-align-left me-1"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </label>
                        <textarea name="Description" id="Description" class="form-control" rows="3" 
                                  placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...">@Model?.Description</textarea>
                    </div>

                    <!-- Project Type and Urgent -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="ProjectType" class="form-label">
                                <i class="fas fa-project-diagram me-1"></i>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£  <span class="text-danger">*</span>
                            </label>

                            <select asp-for="ProjectType" class="form-select">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                                <option value="Replacement">Replacement</option>
                                <option value="Upgrade">Upgrade</option>
                                <option value="Compliance">Compliance</option>
                                <option value="Expansion">Expansion</option>
                                <option value="Replacement/Upgrade">Replacement/Upgrade</option>
                                <option value="Quality Improvement">Quality Improvement</option>
                                <option value="Strategic">Strategic</option>
                                <option value="Productivity">Productivity</option>
                                <option value="Cost Saving">Cost Saving</option>
                                <option value="Safety">Safety</option>
                            </select>

                            <span asp-validation-for="ProjectType" class="text-danger"></span>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label asp-for="Urgent" class="form-label">
                                <i class="fas fa-exclamation-circle me-1"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô  <span class="text-danger">*</span>
                            </label>

                            <select asp-for="Urgent" class="form-select">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
                                <option value="1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
                                <option value="2.‡∏î‡πà‡∏ß‡∏ô">2.‡∏î‡πà‡∏ß‡∏ô</option>
                                <option value="3.‡∏õ‡∏Å‡∏ï‡∏¥">3.‡∏õ‡∏Å‡∏ï‡∏¥</option>
                            </select>
                            <span asp-validation-for="Urgent" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <!-- Start Date -->

                    <div class="mb-3">

                        <label asp-for="StartDate" class="form-label">

                            <i class="fas fa-calendar me-1"></i>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£

                        </label>

                        <input asp-for="StartDate" type="date" class="form-control">

                        <span asp-validation-for="StartDate" class="text-danger"></span>

                    </div>

                    

                    <!-- Amount -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="Amount" class="form-label">
                                <i class="fas fa-money-bill-wave me-1"></i>‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠ (‡∏ö‡∏≤‡∏ó) <span class="text-danger">*</span>
                            </label>
                            <input type="number" name="Amount" id="Amount" class="form-control" 
                                   value="@(Model?.Amount ?? 0)" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ApprovedAmount" class="form-label">
                                <i class="fas fa-check-circle me-1"></i>‡∏á‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ö‡∏≤‡∏ó)
                            </label>
                            <input type="number" name="ApprovedAmount" id="ApprovedAmount" class="form-control" 
                                   value="@(Model?.ApprovedAmount ?? 0)" placeholder="0.00" step="0.01" min="0">
                            <small class="text-muted">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</small>
                        </div>
                    </div>

                    <!-- Benefits -->
                    <div class="mb-3">
                        <label for="Benefits" class="form-label">
                            <i class="fas fa-thumbs-up me-1"></i>‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                        </label>
                        <textarea name="Benefits" id="Benefits" class="form-control" rows="2" 
                                  placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö...">@Model?.Benefits</textarea>
                    </div>

                    <!-- Worthiness -->
                    <div class="mb-3">
                        <label for="Worthiness" class="form-label">
                            <i class="fas fa-star me-1"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤
                        </label>
                        <textarea name="Worthiness" id="Worthiness" class="form-control" rows="2" 
                                  placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô...">@Model?.Worthiness</textarea>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="Notes" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                        </label>
                        <textarea name="Notes" id="Notes" class="form-control" rows="2" 
                                  placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...">@Model?.Notes</textarea>
                    </div>

                    <!-- Status -->
                    <div class="mb-4">
                        <label for="Status" class="form-label">
                            <i class="fas fa-flag me-1"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        </label>
                        <select name="Status" id="Status" class="form-select">
                            <option value="proposed">‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ (Proposed)</option>
                            <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (Approved)</option>
                            <option value="rejected">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Rejected)</option>
                        </select>
                    </div>

                    <!-- ‚úÖ NEW: File Upload Section -->
                    <div class="mb-3">
                        <label asp-for="UploadedFile" class="form-label">
                            <i class="fas fa-paperclip me-1"></i>‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                        </label>
                        <input asp-for="UploadedFile" type="file" class="form-control"
                               accept=".pdf,.pptx,.xlsx,.csv"
                               onchange="showFileInfo(this)">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: PDF, PowerPoint, Excel, CSV (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 MB)
                        </small>
                        <div id="fileInfo" class="mt-2"></div>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="/Budget/Index" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    function showFileInfo(input) {
        const fileInfo = document.getElementById('fileInfo');
            
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const fileName = file.name;
            const fileSize = (file.size / 1024).toFixed(2); // KB
            const fileExtension = fileName.split('.').pop().toLowerCase();
                
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ü‡∏•‡πå
            const allowedExtensions = ['pdf', 'pptx', 'xlsx', 'csv'];
            if (!allowedExtensions.includes(fileExtension)) {
                fileInfo.innerHTML = `
                    <div class="alert alert-danger alert-sm">
                        <i class="fas fa-times-circle me-2"></i>
                        ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞: .pdf, .pptx, .xlsx, .csv
                    </div>
                `;
                input.value = '';
                return;
            }
                
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå (10 MB)
            if (file.size > 10 * 1024 * 1024) {
                fileInfo.innerHTML = `
                    <div class="alert alert-danger alert-sm">
                        <i class="fas fa-times-circle me-2"></i>
                        ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ! ‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 MB
                    </div>
                `;
                input.value = '';
                return;
            }
                
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå
            const icon = getFileIcon(fileExtension);
            fileInfo.innerHTML = `
                <div class="alert alert-success alert-sm">
                    <i class="${icon} me-2"></i>
                    <strong>${fileName}</strong> (${fileSize} KB)
                </div>
            `;
        } else {
            fileInfo.innerHTML = '';
        }
    }
        
    function getFileIcon(extension) {
        switch(extension) {
            case 'pdf': return 'fas fa-file-pdf text-danger';
            case 'pptx': return 'fas fa-file-powerpoint text-warning';
            case 'xlsx': return 'fas fa-file-excel text-success';
            case 'csv': return 'fas fa-file-csv text-info';
            default: return 'fas fa-file';
        }
    }
    console.log('‚úÖ Script loaded');
    
    $(document).ready(function() {
        console.log('‚úÖ Document ready');
        loadDepartments();
        
        // Debug form submit
        $('form').on('submit', function(e) {
            console.log('üîµ FORM SUBMIT - Sending to /Budget/CreatePost');
            
            const formData = new FormData(this);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
                console.log(`  ${key}: ${value}`);
            }
            
            console.log('üì¶ Form Data Object:', JSON.stringify(data, null, 2));
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            if (!data.Category || data.Category === '') {
                alert('‚ùå Category is empty!');
                e.preventDefault();
                return false;
            }
            if (!data.Item || data.Item === '') {
                alert('‚ùå Item is empty!');
                e.preventDefault();
                return false;
            }
            if (!data.Amount || parseFloat(data.Amount) <= 0) {
                alert('‚ùå Amount is empty or zero!');
                e.preventDefault();
                return false;
            }
            
            console.log('‚úÖ Validation passed, submitting to CreatePost...');
        });
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    async function loadDepartments() {
        try {
            const response = await fetch('/api/Department/departments');
            if (!response.ok) {
                console.error('‚ùå Failed to load departments:', response.status);
                return;
            }
            
            const departments = await response.json();
            console.log('‚úÖ Departments loaded:', departments.length);
            
            const select = $('#departmentSelect');
            select.empty();
            select.append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô --</option>');
            
            departments.forEach(dept => {
                select.append(`<option value="${dept.id}" data-name="${dept.name}">${dept.name}</option>`);
            });
        } catch (error) {
            console.error('‚ùå Error loading departments:', error);
        }
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    $('#departmentSelect').change(async function() {
        const selectedOption = $(this).find('option:selected');
        const departmentId = $(this).val();
        const departmentName = selectedOption.data('name');
        
        console.log('Department selected:', departmentName);
        $('#departmentName').val(departmentName || '');
        
        $('#divisionSelect').empty().append('<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>').prop('disabled', true);
        $('#divisionName').val('');
        
        if (departmentId) {
            await loadDivisions(departmentId);
        } else {
            $('#divisionSelect').empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option>');
        }
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢
    async function loadDivisions(departmentId) {
        try {
            const response = await fetch(`/api/Department/divisions/${departmentId}`);
            if (!response.ok) {
                console.error('‚ùå Failed to load divisions:', response.status);
                return;
            }
            
            const divisions = await response.json();
            console.log('‚úÖ Divisions loaded:', divisions.length);
            
            const select = $('#divisionSelect');
            select.empty();
            select.append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢ --</option>');
            
            divisions.forEach(div => {
                select.append(`<option value="${div.id}" data-name="${div.name}">${div.name}</option>`);
            });
            
            select.prop('disabled', false);
        } catch (error) {
            console.error('‚ùå Error loading divisions:', error);
            $('#divisionSelect').empty().append('<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>');
        }
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢
    $('#divisionSelect').change(function() {
        const selectedOption = $(this).find('option:selected');
        const divisionName = selectedOption.data('name');
        
        console.log('Division selected:', divisionName);
        $('#divisionName').val(divisionName || '');
    });
</script>
}
