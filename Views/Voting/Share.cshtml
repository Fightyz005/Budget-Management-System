@model BudgetManagementSystem.Web.Models.VotingSession
@{
    ViewData["Title"] = "แชร์การลงคะแนน";

    // ✅ Null Check ก่อนใช้งาน
    var voteUrl = Model != null && !string.IsNullOrEmpty(Model.VoteId)
        ? $"{Context.Request.Scheme}://{Context.Request.Host}/Voting/Vote/{Model.VoteId}"
        : "#";
}

@if (Model == null)
{
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="alert alert-danger">
                <h4><i class="fas fa-exclamation-triangle me-2"></i>เกิดข้อผิดพลาด</h4>
                <p>ไม่พบข้อมูลเซสชันการลงคะแนน</p>
                <a href="/Budget/Index" class="btn btn-primary mt-3">
                    <i class="fas fa-arrow-left me-2"></i>กลับหน้าหลัก
                </a>
            </div>
        </div>
    </div>
}
else
{
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Success Card -->
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        สร้างการลงคะแนนสำเร็จ!
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <i class="fas fa-info-circle me-2"></i>
                        การลงคะแนนของคุณถูกสร้างเรียบร้อยแล้ว กรุณาแชร์ลิงก์หรือ QR Code ด้านล่างให้ผู้มีสิทธิ์ลงคะแนน
                    </div>

                    <!-- Voting Details -->
                    <div class="mb-4">
                        <h5><i class="fas fa-info me-2"></i>รายละเอียด</h5>
                        <dl class="row">
                            <dt class="col-sm-3">Vote ID:</dt>
                            <dd class="col-sm-9">
                                <span class="badge bg-primary fs-6">@Model.VoteId</span>
                            </dd>

                            <dt class="col-sm-3">หัวข้อ:</dt>
                            <dd class="col-sm-9"><strong>@Model.Title</strong></dd>

                            @if (!string.IsNullOrEmpty(Model.Description))
                            {
                                <dt class="col-sm-3">รายละเอียด:</dt>
                                <dd class="col-sm-9">@Model.Description</dd>
                            }

                            <dt class="col-sm-3">งบประมาณ:</dt>
                            <dd class="col-sm-9">
                                <strong class="text-primary">฿@Model.Amount.ToString("N2")</strong>
                            </dd>

                            <dt class="col-sm-3">จำนวนผู้ลงคะแนน:</dt>
                            <dd class="col-sm-9">@Model.VotersList.Count คน</dd>

                            <dt class="col-sm-3">สถานะ:</dt>
                            <dd class="col-sm-9">
                                @if (Model.IsClosed)
                                {
                                    <span class="badge bg-danger">ปิดแล้ว</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">เปิดรับคะแนน</span>
                                }
                            </dd>

                            <dt class="col-sm-3">สร้างเมื่อ:</dt>
                            <dd class="col-sm-9">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</dd>
                        </dl>
                    </div>

                    <!-- QR Code Section -->
                    <div class="card bg-light mb-4">
                        <div class="card-body text-center">
                            <h5 class="mb-3">
                                <i class="fas fa-qrcode me-2"></i>QR Code สำหรับลงคะแนน
                            </h5>

                            <!-- Loading State -->
                            <div id="qrcode-loading" class="mb-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">กำลังสร้าง QR Code...</span>
                                </div>
                                <p class="mt-2 text-muted">กำลังสร้าง QR Code...</p>
                            </div>

                            <!-- QR Code Container (Hidden initially) -->
                            <div id="qrcode-container" style="display: none;">
                                <div id="qrcode" class="d-inline-block mb-3"></div>

                                <p class="text-muted mb-3">
                                    <i class="fas fa-mobile-alt me-2"></i>
                                    สแกน QR Code ด้วยมือถือเพื่อเข้าสู่หน้าลงคะแนน
                                </p>

                                <!-- Download QR Code Button -->
                                <button onclick="downloadQRCode()" class="btn btn-primary">
                                    <i class="fas fa-download me-2"></i>ดาวน์โหลด QR Code
                                </button>
                            </div>

                            <!-- Error State (Hidden initially) -->
                            <div id="qrcode-error" style="display: none;">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    ไม่สามารถสร้าง QR Code ได้ กรุณาใช้ลิงก์ด้านล่างแทน
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Share Link -->
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h5 class="mb-3">
                                <i class="fas fa-link me-2"></i>ลิงก์สำหรับลงคะแนน
                            </h5>

                            <div class="input-group mb-3">
                                <input type="text" id="voteUrl" class="form-control form-control-lg"
                                       value="@voteUrl" readonly>
                                <button class="btn btn-primary" type="button" onclick="copyLink()">
                                    <i class="fas fa-copy me-2"></i>คัดลอก
                                </button>
                            </div>

                            <div class="d-flex gap-2 flex-wrap">
                                <a href="https://line.me/R/msg/text/?@Uri.EscapeDataString(voteUrl)"
                                   target="_blank" class="btn btn-success">
                                    <i class="fab fa-line me-2"></i>แชร์ใน LINE
                                </a>
                                <a href="mailto:?subject=@Uri.EscapeDataString(Model.Title)&body=@Uri.EscapeDataString(voteUrl)"
                                   class="btn btn-info">
                                    <i class="fas fa-envelope me-2"></i>ส่งอีเมล
                                </a>
                                <a href="@voteUrl" target="_blank" class="btn btn-secondary">
                                    <i class="fas fa-external-link-alt me-2"></i>เปิดหน้าลงคะแนน
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Voters List -->
                    @if (Model.VotersList != null && Model.VotersList.Count > 0)
                    {
                        <div class="card">
                            <div class="card-body">
                                <h5 class="mb-3">
                                    <i class="fas fa-users me-2"></i>รายชื่อผู้มีสิทธิ์ลงคะแนน
                                </h5>
                                <ul class="list-group">
                                    @foreach (var voter in Model.VotersList)
                                    {
                                        <li class="list-group-item">
                                            <i class="fas fa-user-circle text-primary me-2"></i>
                                            @voter
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    }

                    <!-- Actions -->
                    <div class="mt-4 d-flex gap-2 justify-content-end">
                        <a href="/Voting/Results/@Model.VoteId" class="btn btn-warning">
                            <i class="fas fa-chart-bar me-2"></i>ดูผลคะแนน
                        </a>
                        <a href="/Budget/Index" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>กลับหน้าหลัก
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // ===== กำหนดตัวแปร Global =====
        var voteUrl = '@Html.Raw(voteUrl)';
        var voteTitle = '@Html.Raw(Model.Title.Replace("'", "\\'"))';
        var voteId = '@Model.VoteId';
        var qrcodeInstance = null;

        // ===== ฟังก์ชันสร้าง QR Code =====
        function initQRCode() {
            console.log('=== Initializing QR Code ===');
            console.log('Vote URL:', voteUrl);

            try {
                // ตรวจสอบว่า QRCode library โหลดแล้วหรือยัง
                if (typeof QRCode === 'undefined') {
                    console.error('QRCode library not loaded yet');
                    return false;
                }

                // ซ่อน loading, แสดง QR Code container
                document.getElementById('qrcode-loading').style.display = 'none';
                document.getElementById('qrcode-container').style.display = 'block';

                // สร้าง QR Code
                qrcodeInstance = new QRCode(document.getElementById("qrcode"), {
                    text: voteUrl,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                console.log('=== QR Code Created Successfully ===');
                return true;

            } catch (error) {
                console.error('=== Error Creating QR Code ===', error);
                handleQRCodeError();
                return false;
            }
        }

        // ===== ฟังก์ชันจัดการ Error =====
        function handleQRCodeError() {
            console.error('=== QR Code Error Handler ===');
            document.getElementById('qrcode-loading').style.display = 'none';
            document.getElementById('qrcode-error').style.display = 'block';
        }

        // ===== ฟังก์ชันคัดลอกลิงก์ =====
        function copyLink() {
            var input = document.getElementById('voteUrl');
            input.select();
            input.setSelectionRange(0, 99999);

            navigator.clipboard.writeText(input.value).then(function() {
                var btn = event.target.closest('button');
                var originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>คัดลอกแล้ว!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-primary');

                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                }, 2000);
            }).catch(function(err) {
                console.error('Copy failed:', err);
                alert('ไม่สามารถคัดลอกได้ กรุณาคัดลอกด้วยตัวเอง');
            });
        }

        // ===== ฟังก์ชันดาวน์โหลด QR Code =====
        function downloadQRCode() {
            try {
                var canvas = document.querySelector('#qrcode canvas');
                if (!canvas) {
                    alert('ไม่พบ QR Code กรุณารีเฟรชหน้าเว็บ');
                    return;
                }

                // สร้าง canvas ใหม่พร้อมข้อความ
                var finalCanvas = document.createElement('canvas');
                var ctx = finalCanvas.getContext('2d');

                // ขนาด canvas
                var padding = 40;
                var textHeight = 100;
                finalCanvas.width = canvas.width + (padding * 2);
                finalCanvas.height = canvas.height + (padding * 2) + textHeight;

                // พื้นหลังสีขาว
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

                // วาด QR Code
                ctx.drawImage(canvas, padding, padding);

                // เพิ่มข้อความด้านบน
                ctx.fillStyle = '#000000';
                ctx.font = 'bold 20px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('สแกนเพื่อลงคะแนน', finalCanvas.width / 2, 28);

                // เพิ่มชื่อการลงคะแนน
                ctx.font = '16px Arial, sans-serif';
                var maxWidth = finalCanvas.width - (padding * 2);
                var y = canvas.height + padding + 30;

                var lines = wrapText(ctx, voteTitle, maxWidth);
                for (var i = 0; i < lines.length; i++) {
                    ctx.fillText(lines[i], finalCanvas.width / 2, y);
                    y += 22;
                }

                // Vote ID
                y += 10;
                ctx.font = 'bold 14px Arial, sans-serif';
                ctx.fillStyle = '#666666';
                ctx.fillText('Vote ID: ' + voteId, finalCanvas.width / 2, y);

                // ดาวน์โหลด
                var url = finalCanvas.toDataURL('image/png');
                var link = document.createElement('a');
                link.download = 'QRCode_Vote_' + voteId + '.png';
                link.href = url;
                link.click();

                // แสดงข้อความสำเร็จ
                var btn = event.target;
                var originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>ดาวน์โหลดแล้ว!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-primary');

                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                }, 2000);

            } catch (error) {
                console.error('Download error:', error);
                alert('เกิดข้อผิดพลาดในการดาวน์โหลด QR Code');
            }
        }

        // ===== ฟังก์ชันช่วยแบ่งข้อความ =====
        function wrapText(ctx, text, maxWidth) {
            var words = text.split(' ');
            var lines = [];
            var currentLine = '';

            for (var i = 0; i < words.length; i++) {
                var testLine = currentLine + words[i] + ' ';
                var metrics = ctx.measureText(testLine);

                if (metrics.width > maxWidth && i > 0) {
                    lines.push(currentLine.trim());
                    currentLine = words[i] + ' ';
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine.trim());

            // จำกัดไม่เกิน 3 บรรทัด
            if (lines.length > 3) {
                lines[2] = lines[2].substring(0, 40) + '...';
                return lines.slice(0, 3);
            }

            return lines;
        }

        // ===== Auto-select URL =====
        document.getElementById('voteUrl').addEventListener('click', function() {
            this.select();
        });
    </script>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
            integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>

    <!-- Initialize QR Code after library loads -->
    <script>
        (function() {
            console.log('=== Starting QR Code Initialization ===');

            var attempts = 0;
            var maxAttempts = 50; // 5 วินาที (50 x 100ms)

            var checkAndInit = setInterval(function() {
                attempts++;

                if (typeof QRCode !== 'undefined') {
                    console.log('=== QRCode Library Loaded (attempt ' + attempts + ') ===');
                    clearInterval(checkAndInit);
                    initQRCode();
                } else if (attempts >= maxAttempts) {
                    console.error('=== QRCode Library Failed to Load (timeout after ' + attempts + ' attempts) ===');
                    clearInterval(checkAndInit);
                    handleQRCodeError();
                }
            }, 100); // ตรวจสอบทุก 100ms
        })();
    </script>

    <style>
        #qrcode {
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

            #qrcode img {
                border-radius: 5px;
            }

            #qrcode canvas {
                border-radius: 5px;
            }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>

}
